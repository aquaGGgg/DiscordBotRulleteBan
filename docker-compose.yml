services:
  postgres:
    image: postgres:16-alpine
    container_name: dsbot-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_DATABASE}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    ports:
      - "${DB_PORT}:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME} -d ${DB_DATABASE}"]
      interval: 5s
      timeout: 3s
      retries: 20

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: dsbot-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
      PGADMIN_CONFIG_SERVER_MODE: "False"
    ports:
      - "${PGADMIN_PORT}:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      postgres:
        condition: service_healthy

  backend:
    container_name: dsbot-backend
    restart: unless-stopped
    build:
      context: ./BackendDSBot
      dockerfile: Dockerfile
      target: dev
    environment:
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT}
      ASPNETCORE_URLS: http://0.0.0.0:8080
      ConnectionStrings__Default: "Host=postgres;Port=5432;Database=${DB_DATABASE};Username=${DB_USERNAME};Password=${DB_PASSWORD}"
    ports:
      - "${BACKEND_PORT}:8080"
    volumes:
      - ./BackendDSBot:/src
      - nuget_cache:/root/.nuget/packages
    working_dir: /src
    command: ["dotnet","watch","run","--project","BackendDSBot.csproj","--urls","http://0.0.0.0:8080"]
    depends_on:
      postgres:
        condition: service_healthy

  admin-panel:
    container_name: dsbot-admin-panel
    restart: unless-stopped
    build:
      context: ./AdminPanelVue
      dockerfile: Dockerfile
      target: dev
    environment:
      NODE_ENV: ${NODE_ENV}
      VITE_API_BASE_URL: ${VITE_API_BASE_URL}
    ports:
      - "${ADMIN_PORT}:5173"
    volumes:
      - ./AdminPanelVue:/app
      - admin_node_modules:/app/node_modules
    working_dir: /app
    command: ["npm","run","dev","--","--host","0.0.0.0","--port","5173"]
    depends_on:
      - backend

  ds-bot:
    container_name: dsbot-ds-bot
    restart: unless-stopped
    build:
      context: ./NodeJSDSBot
      dockerfile: Dockerfile
      target: dev
    environment:
      NODE_ENV: ${NODE_ENV}
      DISCORD_TOKEN: ${DISCORD_TOKEN}
      BOT_BACKEND_BASE_URL: ${BOT_BACKEND_BASE_URL}
    volumes:
      - ./NodeJSDSBot:/app
      - bot_node_modules:/app/node_modules
    working_dir: /app
    command: ["npm","run","dev"]
    depends_on:
      - backend

volumes:
  pg_data:
  pgadmin_data:
  nuget_cache:
  bot_node_modules:
  admin_node_modules:
