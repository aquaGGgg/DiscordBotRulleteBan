services:
  postgres:
    image: postgres:16-alpine
    container_name: dsbot-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_DATABASE}
      POSTGRES_USER: ${DB_USERNAME}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    ports:
      - "${DB_PORT}:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
    profiles: ["dev", "prod"]

  backend:
    container_name: dsbot-backend
    build:
      context: ./BackendDSBot
      dockerfile: Dockerfile
      target: dev
    environment:
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT}
      ASPNETCORE_URLS: http://0.0.0.0:${BACKEND_PORT}
      ConnectionStrings__Default: Host=postgres;Port=5432;Database=${DB_DATABASE};Username=${DB_USERNAME};Password=${DB_PASSWORD}
    ports:
      - "${BACKEND_PORT}:${BACKEND_PORT}"
    volumes:
      - ./BackendDSBot:/src
    working_dir: /src
    command: ["dotnet","watch","run","--project","BackendDSBot.csproj","--urls","http://0.0.0.0:8080"]
    profiles: ["dev"]

  admin-panel:
    container_name: dsbot-admin-panel
    build:
      context: ./AdminPanelVue
      dockerfile: Dockerfile
      target: dev
    environment:
      NODE_ENV: ${NODE_ENV}
      VITE_API_BASE_URL: ${VITE_API_BASE_URL}
    ports:
      - "${ADMIN_PORT}:${ADMIN_PORT}"
    volumes:
      - ./AdminPanelVue:/app
      - admin_node_modules:/app/node_modules
    working_dir: /app
    command: ["npm","run","dev","--","--host","0.0.0.0","--port","5173"]
    profiles: ["dev"]

  ds-bot:
    container_name: dsbot-ds-bot
    build:
      context: ./NodeJSDSBot
      dockerfile: Dockerfile
      target: dev
    environment:
      NODE_ENV: ${NODE_ENV}
      DISCORD_TOKEN: ${DISCORD_TOKEN}
      BOT_BACKEND_BASE_URL: ${BOT_BACKEND_BASE_URL}
    volumes:
      - ./NodeJSDSBot:/app
      - bot_node_modules:/app/node_modules
    working_dir: /app
    command: ["npm","run","dev"]
    profiles: ["dev"]

volumes:
  pg_data:
  bot_node_modules:
  admin_node_modules:
