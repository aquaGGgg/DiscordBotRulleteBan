# BannedService — Full Technical Specification

> Документ предназначен для разработчика с опытом (backend + integrations).
> Цель — однозначно понять **что писать**, **как компоненты взаимодействуют**, **какие правила нельзя нарушать**.

---

## 0. Общая идея проекта

BannedService — сервис для Discord-серверов, который:
- регулярно крутит рулетки наказаний (voice jail)
- выдаёт тикеты разбана как валюту
- позволяет пользователям выкупать себя или помогать другим
- управляется через Discord-бота и веб-админку

Ключевая механика — **voice jail**: пользователь принудительно удерживается в голосовом канале "тюрьма" до окончания таймера.

---

## 1. Архитектура (высокоуровнево)

Система состоит из 4 логических компонентов:

1. **API (ASP.NET)**
   - единственный источник истины
   - хранит данные
   - считает рулетки
   - управляет таймерами
   - формирует очередь действий для бота

2. **Discord Bot (Node.js)**
   - интерфейс для пользователей
   - исполняет действия в Discord (voice, DM, SFX)
   - не хранит бизнес-состояние

3. **Admin Panel (Vue SPA)**
   - управление конфигурацией
   - ручные действия
   - статистика

4. **PostgreSQL**
   - основное хранилище

Связи:
- Bot <-> API (REST)
- Admin <-> API (REST)
- API <-> DB

---

## 2. Принципы и ограничения (обязательно)

- API — **истина**, бот — **исполнитель**
- Бот может падать и перезапускаться без потери состояния
- Все действия Discord выполняются через `bot_jobs`
- Нет прямого доступа к БД ни у админки, ни у бота
- Любое изменение тикетов или наказаний фиксируется в истории

---

## 3. Пользовательские роли

### 3.1 User
- участник Discord
- может получать наказания
- может иметь тикеты
- может делать self-unban
- может переводить тикеты

### 3.2 Admin
- один человек
- управляет конфигом
- может вручную сажать/выпускать
- может менять тикеты

---

## 4. Основные сущности (смысл)

### 4.1 User
- привязан к `discord_user_id`
- имеет баланс тикетов

### 4.2 Punishment (Jail)
- активное или завершённое наказание
- всегда имеет `ends_at`
- может стакаться (увеличение времени)

### 4.3 Tickets
- внутренняя валюта
- используется для self-unban
- может передаваться между пользователями

### 4.4 Roulette Rounds
- ban roulette — выдаёт наказания
- ticket roulette — выдаёт тикеты

### 4.5 Bot Jobs
- очередь действий для Discord-бота
- гарантирует доставку действий

---

## 5. Бизнес-правила (критично)

### 5.1 Рулетки
- существует **две независимые рулетки**:
  - ban roulette
  - ticket roulette

- рулетки работают **только по eligible пользователям** (определённая роль Discord)
- список eligible пользователей поставляет бот

### 5.2 Ban roulette
- запускается по интервалу (configurable)
- выбирает N пользователей
- для каждого роллит duration в диапазоне
- если пользователь уже наказан — время **стакуется**
- цена self-unban всегда = 1 тикет

### 5.3 Ticket roulette
- запускается по интервалу
- выбирает победителей
- выдаёт случайное количество тикетов

### 5.4 Self-unban
- пользователь может снять наказание полностью
- требуется достаточное количество тикетов
- при успехе:
  - наказание завершается
  - тикеты списываются

### 5.5 Manual ban
- возможен только если нет активного наказания
- цена self-unban задаётся админом

### 5.6 Истечение наказаний
- отдельный воркер закрывает истёкшие наказания
- при закрытии формируется job RELEASE_JAIL

---

## 6. API — обязанности

API обязано:
- хранить все данные
- валидировать бизнес-правила
- быть идемпотентным
- формировать `bot_jobs`
- работать корректно при параллельных запросах

API **не должно**:
- напрямую обращаться к Discord
- хранить Discord-состояние (voice state)

---

## 7. Bot — обязанности

Bot обязан:
- принимать slash-команды
- отображать пользователю его состояние
- удерживать пользователя в voice jail
- проигрывать звуки
- исполнять очередь jobs

Bot **не должен**:
- решать бизнес-правила
- хранить состояние наказаний как истину

---

## 8. Voice Jail — логика

- существует отдельный voice канал (jail)
- при APPLY_JAIL:
  - если пользователь в voice — переместить
  - включить режим удержания

- при попытке выйти:
  - бот возвращает пользователя обратно

- при RELEASE_JAIL:
  - удержание отключается

---

## 9. Очередь bot_jobs (ключевая часть)

Назначение:
- гарантировать доставку действий в Discord

Правила:
- job имеет статус: pending → processing → done/failed
- job может быть выполнен повторно при сбое
- payload — JSON, зависит от типа

Типы jobs:
- APPLY_JAIL
- RELEASE_JAIL
- DM_NOTIFY
- PLAY_SFX
- SYNC_ROLE_USERS

---

## 10. Admin Panel — назначение

Админка предназначена для:
- управления конфигом
- ручных действий
- мониторинга

Админка **не содержит логики**, только UI.

---

## 11. Deployment

- деплой через Docker Compose
- 4 контейнера: api, bot, admin, db (+ nginx)
- Postgres с volume
- логи ограничены

---

## 12. Что важно для разработчика

- не пытаться "упростить" и убрать bot_jobs
- не переносить логику в бота
- не хранить состояние в памяти бота как истину
- всегда думать о рестартах

---

## 13. MVP приоритеты

Обязательно:
- ban roulette
- voice jail
- self-unban
- ticket transfer
- admin config

Можно позже:
- расширенная статистика
- красивые графики
- дополнительные типы наказаний

---

## 14. Итог

Этот документ описывает **как должен быть реализован сервис**.

Любые изменения архитектуры допустимы только если:
- не нарушается принцип "API — истина"
- сохраняется надёжность при рестартах
- не ломаются бизнес-правила

